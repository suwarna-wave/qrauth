{% extends 'base.html' %}
{% load static %}

{% block content %}
  <style>
    #html5-qrcode-button-camera-permission {
      font-weight: bolder;
      border: 2px solid green;
      background: green;
      color: white;
      padding: 2px;
      text-decoration: underline;
    }
  </style>

  <div class="container mx-auto mt-20">
    <div class="bg-white text-gray-800 mx-auto mt-8 p-8 rounded-lg shadow-lg max-w-md">
      <h1 class="text-4xl font-bold text-center mb-6">Register</h1>

      <!-- Success Message -->
      <div id="success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-6" role="alert">
        <strong class="font-bold">Success!</strong>
        <span class="block sm:inline" id="success-text"></span>
      </div>

      <!-- Error Message -->
      <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
        <strong class="font-bold">Error!</strong>
        <span class="block sm:inline" id="error-text"></span>
      </div>
      <select name="event_day" id="event_day" class="w-full p-2 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 text-black">
        <option value="" disabled selected>Select Event Day</option>
        <option value="Day 1">Day 1</option>
        <option value="Day 2">Day 2</option>
        <option value="Day 3">Day 3</option>
        <option value="Day 4">Day 4</option>
        <option value="Day 5">Day 5</option>
        <option value="Day 6">Day 6</option>
        <option value="Day 7">Day 7</option>
      </select>
      <select name="event" id="event" class="w-full p-2 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 text-black">
        <option value="" disabled selected>Select Event</option>
      </select>

      <!-- QR Code Section -->
      <div class="flex justify-center mb-6">
        <div class="w-72 h-72 bg-gray-100 rounded-lg shadow-inner flex items-center justify-center">
          <div id="reader" class="w-full h-full"></div>
        </div>
      </div>
      <script src="{% static 'js/html5-qrcode.min.js' %}"></script>
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const eventDaySelect = document.getElementById('event_day')
          const eventSelect = document.getElementById('event')
        
          const events = {
            'Day 1': ['Event 1.1', 'Event 1.2'],
            'Day 2': ['Event 2.1', 'Event 2.2'],
            'Day 3': ['Event 3.1', 'Event 3.2'],
            'Day 4': ['Event 4.1', 'Event 4.2'],
            'Day 5': ['Event 5.1', 'Event 5.2'],
            'Day 6': ['Event 6.1', 'Event 6.2'],
            'Day 7': ['Event 7.1', 'Event 7.2'],
          }
        
          eventDaySelect.addEventListener('change', function () {
            const selectedDay = eventDaySelect.value
            const dayEvents = events[selectedDay] || []
        
            // Clear previous options
            eventSelect.innerHTML = '<option value="" disabled selected>Select Event</option>'
        
            // Populate new options
            dayEvents.forEach(function (event) {
              const option = document.createElement('option')
              option.value = event
              option.textContent = event
              eventSelect.appendChild(option)
            })
          })
        })
        
        function onScanSuccess(decodedText, decodedResult) {
          console.log(`Scan result: ${decodedText}`, decodedResult)
        
          // Parse the decoded text
          const lines = decodedText.split('\n')
          const data = {}
          lines.forEach((line) => {
            const [key, value] = line.split(': ')
            data[key.toLowerCase()] = value
          })
        
          // Get the selected event day and event name
          const eventDay = document.getElementById('event_day').value
          const eventName = document.getElementById('event').value
        
          // Add event day and event name to the data
          data['event_day'] = eventDay
          data['event_name'] = eventName
        
          // Send the data to the server
          fetch("{% url 'register_qr' %}", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                document.getElementById('success-text').innerText = data.success
                document.getElementById('success-message').classList.remove('hidden')
                document.getElementById('error-message').classList.add('hidden')
                html5QrcodeScanner.clear()
              } else if (data.error) {
                document.getElementById('error-text').innerText = data.error
                document.getElementById('error-message').classList.remove('hidden')
                document.getElementById('success-message').classList.add('hidden')
              }
            })
            .catch((error) => {
              console.error('Error:', error)
              document.getElementById('error-text').innerText = 'An unexpected error occurred.'
              document.getElementById('error-message').classList.remove('hidden')
              document.getElementById('success-message').classList.add('hidden')
            })
        }
        
        var html5QrcodeScanner = new Html5QrcodeScanner('reader', { fps: 10, qrbox: 250 })
        html5QrcodeScanner.render(onScanSuccess)
      </script>
    </div>
  </div>
{% endblock %}
